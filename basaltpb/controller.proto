syntax = "proto3";

package basaltpb;

option go_package = "github.com/cockroachdb/basaltclient/basaltpb";

import "basaltpb/common.proto";
import "gogoproto/gogo.proto";

option (gogoproto.goproto_getters_all) = false;
option (gogoproto.goproto_unrecognized_all) = false;
option (gogoproto.goproto_sizecache_all) = false;
option (gogoproto.goproto_unkeyed_all) = false;

// Controller coordinates object placement, mounts, and repairs in Basalt.
service Controller {
  // Mount registers a Pebble instance and acquires exclusive write access
  // to its store directory. Returns the mount ID and directory ID.
  rpc Mount(MountRequest) returns (MountResponse);

  // Unmount releases the write lock on a store directory.
  rpc Unmount(UnmountRequest) returns (UnmountResponse);

  // Create allocates a new file in a directory and selects replicas.
  // Requires the caller to hold a mount for the directory, or the directory
  // must not be mounted by anyone.
  rpc Create(CreateRequest) returns (CreateResponse);

  // StatByPath returns metadata for an entry by (directory_id, name).
  // Does not require a mount.
  rpc StatByPath(StatByPathRequest) returns (StatResponse);

  // StatByID returns metadata for an object by ID.
  // Does not require a mount.
  rpc StatByID(StatByIDRequest) returns (StatResponse);

  // Unlink removes an entry from a directory. If this was the last reference
  // to the object, the object and its replicas are scheduled for deletion.
  // Requires mount or unmounted directory.
  rpc Unlink(UnlinkRequest) returns (UnlinkResponse);

  // Seal marks an object as immutable with its final size.
  // Requires mount or unmounted directory.
  rpc Seal(SealRequest) returns (SealResponse);

  // Mkdir creates a subdirectory within a directory.
  // Requires mount or unmounted directory.
  rpc Mkdir(MkdirRequest) returns (MkdirResponse);

  // Rmdir removes an empty directory.
  // Requires mount or unmounted directory.
  rpc Rmdir(RmdirRequest) returns (RmdirResponse);

  // List returns all entries in a directory as a stream.
  // Does not require a mount.
  rpc List(ListRequest) returns (stream DirectoryEntry);

  // Link creates a hardlink to an existing object in a directory.
  // Requires mount or unmounted directory.
  rpc Link(LinkRequest) returns (LinkResponse);

  // Rename moves an entry within the same directory.
  // Requires mount or unmounted directory.
  rpc Rename(RenameRequest) returns (RenameResponse);

  // HeartbeatBlobServer registers a blob server with the controller.
  // Uses UPSERT semantics: handles initial registration, heartbeats, and
  // capacity updates. Blob servers should call this periodically to maintain
  // liveness.
  rpc HeartbeatBlobServer(HeartbeatBlobServerRequest) returns (HeartbeatBlobServerResponse);

  // TODO(cockroachlabs/basalt#4): Add additional RPCs:
  // - Heartbeat for mount liveness
  // - ReportFailure for replica health reporting
}

// TODO(cockroachlabs/basalt#1): Simplify MountRequest to take a directory_id
// instead of cluster_id+store_id, deriving caller identity from the mTLS cert.
message MountRequest {
  // Identifier for this Pebble instance (e.g., node ID + store ID).
  string instance_id = 1;
  // Zone of the mounting node.
  string zone = 2;
  // UUID of the CockroachDB cluster.
  bytes cluster_id = 3 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // UUID of the store within the cluster.
  bytes store_id = 4 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
}

message MountResponse {
  // Unique mount ID for this session.
  bytes mount_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Root directory ID for the mounted store.
  bytes directory_id = 2 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Write token for authenticating with blob servers.
  bytes write_token = 3;
}

message UnmountRequest {
  bytes mount_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
}

message UnmountResponse {}

message CreateRequest {
  // Directory in which to create the file.
  bytes directory_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Name for the new file.
  string name = 2;
  // Replication policy for the new file.
  ReplicationPolicy policy = 3;
}

message CreateResponse {
  ObjectMeta meta = 1;
}

message StatByPathRequest {
  // Directory containing the entry.
  bytes directory_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Name of the entry to stat.
  string name = 2;
  // If true, include all namespace references (hardlinks) in the response.
  bool include_references = 3;
}

message StatByIDRequest {
  // Object ID to stat.
  bytes object_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // If true, include all namespace references (hardlinks) in the response.
  bool include_references = 2;
  // If true, return the object even if it is a zombie (scheduled for deletion).
  bool include_zombies = 3;
}

message StatResponse {
  ObjectMeta meta = 1;
  // Type of the entry (file or directory).
  EntryType type = 2;
  // All namespace references (hardlinks) to this object.
  // Only populated when include_references is set in the request.
  repeated Reference references = 3 [(gogoproto.nullable) = false];
  // True if the object is a zombie (scheduled for deletion).
  bool zombie = 4;
}

message UnlinkRequest {
  // Directory containing the entry to unlink.
  bytes directory_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Name of the entry to unlink.
  string name = 2;
}

message UnlinkResponse {
  // Object ID that was unlinked (for files only).
  bytes object_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // True if this was the last reference and the object will be deleted.
  bool object_deleted = 2;
}

message SealRequest {
  // Object to seal.
  bytes object_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Final size of the object.
  int64 size = 2;
}

message SealResponse {}

message MkdirRequest {
  // Parent directory in which to create the subdirectory.
  bytes parent_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Name for the new directory.
  string name = 2;
}

message MkdirResponse {
  // ID of the newly created directory.
  bytes directory_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
}

message RmdirRequest {
  // Parent directory containing the directory to remove.
  bytes parent_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Name of the directory to remove.
  string name = 2;
}

message RmdirResponse {}

message ListRequest {
  // Directory to list.
  bytes directory_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
}

message LinkRequest {
  // Directory in which to create the link.
  bytes directory_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Name for the new link.
  string name = 2;
  // Existing object to link to.
  bytes object_id = 3 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
}

message LinkResponse {}

message RenameRequest {
  // Directory containing the entry to rename.
  bytes directory_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Current name of the entry.
  string old_name = 2;
  // New name for the entry.
  string new_name = 3;
}

message RenameResponse {}

message HeartbeatBlobServerRequest {
  // UUID generated and persisted by the blob server.
  bytes server_id = 1 [(gogoproto.customtype) = "UUID", (gogoproto.nullable) = false];
  // Addr (host:port) for the gRPC control endpoint.
  string control_addr = 2;
  // Addr (host:port) for the data protocol.
  string data_addr = 3;
  // Zone of the blob server.
  string zone = 4;
  // Total storage capacity in bytes.
  int64 capacity_bytes = 5;
  // Currently used storage in bytes.
  int64 used_bytes = 6;
}

message HeartbeatBlobServerResponse {
  // Integer ID assigned to this blob server, used in objects.replicas arrays.
  int32 disk_id = 1;
}
