# Test Basalt path parsing

# Local paths return nil
parse
/local/path
----
nil (local path)

parse
relative/path
----
nil (local path)

# Direct controller address
parse
//localhost:26257/
----
controllers: localhost:26257
path: /
dir: ""
base: ""
ssd: 3
hdd: 0
archive: false
local_zone: ""

parse
//localhost:26257/dir/file.sst
----
controllers: localhost:26257
path: /dir/file.sst
dir: "/dir"
base: "file.sst"
ssd: 3
hdd: 0
archive: false
local_zone: ""

parse
//host:1234/a/b/c
----
controllers: host:1234
path: /a/b/c
dir: "/a/b"
base: "c"
ssd: 3
hdd: 0
archive: false
local_zone: ""

# Multiple controllers (comma-separated)
parse
//host1:1234,host2:1234/path
----
controllers: host1:1234, host2:1234
path: /path
dir: ""
base: "path"
ssd: 3
hdd: 0
archive: false
local_zone: ""

# Trailing slash means the path is a directory (empty base)
parse
//a:1,b:2,c:3/dir/
----
controllers: a:1, b:2, c:3
path: /dir/
dir: "/dir"
base: ""
ssd: 3
hdd: 0
archive: false
local_zone: ""

# Alias resolution - register aliases for testing

alias
prod controller1:26257,controller2:26257
----
ok

alias
dev localhost:26257
----
ok

# Alias without basalt: prefix
parse
//dev/myfile
----
controllers: localhost:26257
path: /myfile
dir: ""
base: "myfile"
ssd: 3
hdd: 0
archive: false
local_zone: ""

parse
//prod/cluster/store/file.sst
----
controllers: controller1:26257, controller2:26257
path: /cluster/store/file.sst
dir: "/cluster/store"
base: "file.sst"
ssd: 3
hdd: 0
archive: false
local_zone: ""

parse
//prod/
----
controllers: controller1:26257, controller2:26257
path: /
dir: ""
base: ""
ssd: 3
hdd: 0
archive: false
local_zone: ""

# Alias with basalt: scheme prefix
parse
basalt://dev/myfile
----
controllers: localhost:26257
path: /myfile
dir: ""
base: "myfile"
ssd: 3
hdd: 0
archive: false
local_zone: ""

parse
basalt://prod/cluster/store
----
controllers: controller1:26257, controller2:26257
path: /cluster/store
dir: "/cluster"
base: "store"
ssd: 3
hdd: 0
archive: false
local_zone: ""

# Alias with query parameters
parse
basalt://prod/file?ssd=1&archive
----
controllers: controller1:26257, controller2:26257
path: /file
dir: ""
base: "file"
ssd: 1
hdd: 0
archive: true
local_zone: ""

# basalt: scheme prefix with direct address
parse
basalt://localhost:26257/dir/file.sst
----
controllers: localhost:26257
path: /dir/file.sst
dir: "/dir"
base: "file.sst"
ssd: 3
hdd: 0
archive: false
local_zone: ""

parse
basalt://host1:1234,host2:1234/path
----
controllers: host1:1234, host2:1234
path: /path
dir: ""
base: "path"
ssd: 3
hdd: 0
archive: false
local_zone: ""

# basalt: without // is a local path
parse
basalt:localfile
----
nil (local path)

# Replication config via query parameters

parse
//host:1234/path?ssd=2
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 2
hdd: 0
archive: false
local_zone: ""

parse
//host:1234/path?hdd=1
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 3
hdd: 1
archive: false
local_zone: ""

parse
//host:1234/path?ssd=2&hdd=1
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 2
hdd: 1
archive: false
local_zone: ""

parse
//host:1234/path?archive
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 3
hdd: 0
archive: true
local_zone: ""

parse
//host:1234/path?zone=cross
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 3
hdd: 0
archive: false
local_zone: ""

# zone=local requires local-zone to be set
local-zone
us-east-1a
----
ok

parse
//host:1234/path?zone=local
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 3
hdd: 0
archive: false
local_zone: "us-east-1a"

# All parameters combined
local-zone
us-west-2b
----
ok

parse
//host:1234/path?ssd=2&hdd=1&archive&zone=local
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 2
hdd: 1
archive: true
local_zone: "us-west-2b"

# Config works with aliases too
parse
//prod/file?ssd=1&archive
----
controllers: controller1:26257, controller2:26257
path: /file
dir: ""
base: "file"
ssd: 1
hdd: 0
archive: true
local_zone: ""

# archive-only with ssd=0 hdd=0 is valid
parse
//host:1234/path?ssd=0&hdd=0&archive
----
controllers: host:1234
path: /path
dir: ""
base: "path"
ssd: 0
hdd: 0
archive: true
local_zone: ""

# Reset local-zone for error tests
local-zone

----
ok

# Error cases

parse
//
----
error: empty controller address or alias

parse
basalt://
----
error: empty controller address or alias

# Unknown alias
parse
//unknown/path
----
error: resolving alias "unknown": unknown alias: unknown

# Unknown query parameter (catches typos)
parse
//host:1234/path?sssd=3
----
error: unknown query parameter: "sssd"

# Invalid ssd value
parse
//host:1234/path?ssd=abc
----
error: invalid ssd value "abc": strconv.ParseInt: parsing "abc": invalid syntax

# Negative ssd value
parse
//host:1234/path?ssd=-1
----
error: ssd must be non-negative, got -1

# Invalid hdd value
parse
//host:1234/path?hdd=xyz
----
error: invalid hdd value "xyz": strconv.ParseInt: parsing "xyz": invalid syntax

# Negative hdd value
parse
//host:1234/path?hdd=-2
----
error: hdd must be non-negative, got -2

# Invalid zone value
parse
//host:1234/path?zone=invalid
----
error: invalid zone value "invalid": must be "cross" or "local"

# zone=local without local-zone set
parse
//host:1234/path?zone=local
----
error: zone=local requires localZone parameter

# Zero replicas without archive is an error
parse
//host:1234/path?ssd=0&hdd=0
----
error: at least one replica required (ssd + hdd >= 1) unless archive is enabled
